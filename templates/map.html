<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ëšœë”° ì§€ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ api_key }}&autoload=false"></script>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      #map {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      // Jinja2 ë³€ìˆ˜ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ë³€í™˜
      const initialLat = parseFloat("{{ lat }}");
      const initialLng = parseFloat("{{ lng }}");

      // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë§ˆì»¤ ë°ì´í„°
      let initialMarkers = [];
      {% if markers %}
        try {
          initialMarkers = JSON.parse('{{ markers|tojson }}');
        } catch (e) {
          console.error("ë§ˆì»¤ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", e);
        }
      {% endif %}

      kakao.maps.load(function () {
        const container = document.getElementById("map");
        const options = {
          center: new kakao.maps.LatLng(initialLat, initialLng),
          level: 3
        };

        // ì§€ë„ ìƒì„±
        const map = new kakao.maps.Map(container, options);

        // ë§ˆì»¤ ì €ì¥ìš© ë°°ì—´
        let markers = [];

        // ğŸ†• ê²½ë¡œ ê´€ë ¨ ë³€ìˆ˜
        let currentPolyline = null; // í˜„ì¬ ê·¸ë ¤ì§„ ê²½ë¡œ
        let routeMarkers = []; // ê²½ë¡œ ì‹œì‘/ë ë§ˆì»¤ë“¤

        // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ìƒì„±
        addMarker({
          id: "current-location",
          title: "í˜„ì¬ ìœ„ì¹˜",
          description: "í˜„ì¬ ìœ„ì¹˜ì…ë‹ˆë‹¤.",
          lat: initialLat,
          lng: initialLng
        }, true);

        // ì„œë²„ì—ì„œ ë°›ì€ ì´ˆê¸° ë§ˆì»¤ë“¤ ì¶”ê°€
        if (initialMarkers.length > 0) {
          initialMarkers.forEach(marker => {
            addMarker({
              id: marker.id,
              title: marker.title,
              description: marker.description || "",
              lat: marker.coordinate.latitude,
              lng: marker.coordinate.longitude
            });
          });
        }

        // ë§ˆì»¤ ì¶”ê°€ í•¨ìˆ˜
        function addMarker(markerData, isCurrentLocation = false) {
          const position = new kakao.maps.LatLng(markerData.lat, markerData.lng);

          // ë§ˆì»¤ ì˜µì…˜ ì„¤ì •
          let markerOptions = {
            position: position,
            map: map,
            title: markerData.title
          };

          // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ëŠ” ë‹¤ë¥¸ ì´ë¯¸ì§€ ì‚¬ìš©
          if (isCurrentLocation) {
            const imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
            const imageSize = new kakao.maps.Size(24, 35);
            const imageOption = {offset: new kakao.maps.Point(12, 35)};
            markerOptions.image = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
          }

          // ë§ˆì»¤ ìƒì„±
          const marker = new kakao.maps.Marker(markerOptions);

          // ë§ˆì»¤ ë°ì´í„° ì €ì¥
          marker.data = markerData;
          markers.push(marker);

          // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
          kakao.maps.event.addListener(marker, 'click', function() {
            // React Native ì›¹ë·°ë¡œ ë©”ì‹œì§€ ì „ì†¡
            if (window.ReactNativeWebView) {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: "markerClick",
                id: markerData.id,
                title: markerData.title,
                description: markerData.description || "",
                lat: markerData.lat,
                lng: markerData.lng
              }));
            }

            // ì¸í¬ìœˆë„ìš° í‘œì‹œ
            var infowindow = new kakao.maps.InfoWindow({
              content: '<div style="padding:5px;">' + markerData.title + '</div>'
            });
            infowindow.open(map, marker);

            // 3ì´ˆ í›„ ì¸í¬ìœˆë„ìš° ë‹«ê¸°
            setTimeout(() => infowindow.close(), 3000);
          });

          return marker;
        }

        // ğŸ†• ê²½ë¡œ ê·¸ë¦¬ê¸° í•¨ìˆ˜
        window.drawRoute = function(routeData) {
          console.log("ğŸ—ºï¸ ê²½ë¡œ ê·¸ë¦¬ê¸° ì‹œì‘:", routeData.length, "ê°œ í¬ì¸íŠ¸");

          // ê¸°ì¡´ ê²½ë¡œ ì‚­ì œ
          clearRoute();

          if (!routeData || routeData.length < 2) {
            console.warn("ê²½ë¡œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ 2ê°œ í¬ì¸íŠ¸ í•„ìš”");
            return;
          }

          try {
            // ê²½ë¡œ ì¢Œí‘œ ë³€í™˜
            const path = routeData.map(point => new kakao.maps.LatLng(point.lat, point.lng));

            // í´ë¦¬ë¼ì¸ ìƒì„±
            currentPolyline = new kakao.maps.Polyline({
              path: path,
              strokeWeight: 5,
              strokeColor: '#007AFF', // iOS ìŠ¤íƒ€ì¼ íŒŒë€ìƒ‰
              strokeOpacity: 0.8,
              strokeStyle: 'solid'
            });

            // ì§€ë„ì— í´ë¦¬ë¼ì¸ í‘œì‹œ
            currentPolyline.setMap(map);

            // ì¶œë°œì§€ ë§ˆì»¤ ì¶”ê°€
            const startMarker = new kakao.maps.Marker({
              position: path[0],
              map: map,
              image: new kakao.maps.MarkerImage(
                'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/red_b.png',
                new kakao.maps.Size(50, 45),
                { offset: new kakao.maps.Point(15, 43) }
              )
            });

            // ë„ì°©ì§€ ë§ˆì»¤ ì¶”ê°€
            const endMarker = new kakao.maps.Marker({
              position: path[path.length - 1],
              map: map,
              image: new kakao.maps.MarkerImage(
                'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/blue_b.png',
                new kakao.maps.Size(50, 45),
                { offset: new kakao.maps.Point(15, 43) }
              )
            });

            // ê²½ë¡œ ë§ˆì»¤ë“¤ ì €ì¥
            routeMarkers = [startMarker, endMarker];

            // ì¶œë°œì§€/ë„ì°©ì§€ ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
            kakao.maps.event.addListener(startMarker, 'click', function() {
              showInfoWindow(startMarker, "ì¶œë°œì§€", path[0]);
            });

            kakao.maps.event.addListener(endMarker, 'click', function() {
              showInfoWindow(endMarker, "ë„ì°©ì§€", path[path.length - 1]);
            });

            // ê²½ë¡œê°€ ëª¨ë‘ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¡°ì •
            const bounds = new kakao.maps.LatLngBounds();
            path.forEach(point => bounds.extend(point));
            map.setBounds(bounds);

            console.log("âœ… ê²½ë¡œ ê·¸ë¦¬ê¸° ì™„ë£Œ");

            // React Nativeë¡œ ì™„ë£Œ ì•Œë¦¼
            if (window.ReactNativeWebView) {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: "routeDrawn",
                pointCount: routeData.length
              }));
            }

          } catch (error) {
            console.error("âŒ ê²½ë¡œ ê·¸ë¦¬ê¸° ì˜¤ë¥˜:", error);
            if (window.ReactNativeWebView) {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: "routeError",
                error: error.message
              }));
            }
          }
        };

        // ğŸ†• ê²½ë¡œ ì‚­ì œ í•¨ìˆ˜
        window.clearRoute = function() {
          console.log("ğŸ—ºï¸ ê²½ë¡œ ì‚­ì œ");

          // í´ë¦¬ë¼ì¸ ì‚­ì œ
          if (currentPolyline) {
            currentPolyline.setMap(null);
            currentPolyline = null;
          }

          // ê²½ë¡œ ë§ˆì»¤ë“¤ ì‚­ì œ
          routeMarkers.forEach(marker => {
            marker.setMap(null);
          });
          routeMarkers = [];

          console.log("âœ… ê²½ë¡œ ì‚­ì œ ì™„ë£Œ");
        };

        // ğŸ†• ì¸í¬ìœˆë„ìš° í‘œì‹œ í•¨ìˆ˜
        function showInfoWindow(marker, title, position) {
          const infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:8px; font-size:12px; text-align:center;">
                        <strong>${title}</strong><br/>
                        ${position.getLat().toFixed(6)}, ${position.getLng().toFixed(6)}
                      </div>`
          });
          infowindow.open(map, marker);
          setTimeout(() => infowindow.close(), 3000);
        }

        // ë§ˆì»¤ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì›¹ë·°ì—ì„œ í˜¸ì¶œ)
        window.updateMarkers = function(markersData) {
          // ê¸°ì¡´ ë§ˆì»¤ ì œê±° (í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì œì™¸)
          markers.forEach(marker => {
            if (marker.data.id !== "current-location") {
              marker.setMap(null);
            }
          });

          markers = markers.filter(marker => marker.data.id === "current-location");

          // ìƒˆ ë§ˆì»¤ ì¶”ê°€
          markersData.forEach(markerData => {
            addMarker({
              id: markerData.id,
              title: markerData.title,
              description: markerData.description || "",
              lat: markerData.coordinate.latitude,
              lng: markerData.coordinate.longitude
            });
          });
        };

        // í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™ í•¨ìˆ˜ (ì›¹ë·°ì—ì„œ í˜¸ì¶œ)
        window.moveToLocation = function(lat, lng) {
          map.setCenter(new kakao.maps.LatLng(lat, lng));
        };

        // ì§€ë„ ì´ë™ ì´ë²¤íŠ¸
        kakao.maps.event.addListener(map, 'dragend', function() {
          const center = map.getCenter();
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({
              type: "mapMoved",
              lat: center.getLat(),
              lng: center.getLng()
            }));
          }
        });

        // ğŸ†• ì´ˆê¸°í™” ì™„ë£Œ ì•Œë¦¼
        setTimeout(() => {
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({
              type: "ready"
            }));
          }
          console.log("ğŸ—ºï¸ ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì™„ë£Œ");
        }, 500); // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ì•ˆì •ì„± í™•ë³´
      });
    </script>
  </body>
</html>
